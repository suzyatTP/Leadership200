<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leadership 200 – Scale of Gifts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue: #007dba;       /* primary ocean blue */
      --blue-dark: #006da3;  /* deep header blue */
      --teal: #00878c;       /* accent teal */
      --accent-gold: #bb723a;/* copper accent */
      --bg: #eafdff;         /* airy aqua background */
      --card: #ffffff;
      --text-main: #123044;
      --text-soft: #35586b;
      --shadow-soft: 0 16px 40px rgba(8, 46, 75, 0.18);
    }

    * {
      box-sizing: border-box;
      font-family: "Georgia", "Times New Roman", serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #eafdff 0%, #ffffff 55%, #e5f4ff 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1360px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    /* HEADER -------------------------------------------------------- */

    .header {
      text-align: center;
      padding: 18px 26px 12px;
    }

    .header-line-1 {
      font-size: 11px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: var(--blue-dark);
    }

    .header-title {
      margin: 6px 0 4px;
      font-size: 44px;
      letter-spacing: 0.18em;
      color: var(--teal);
    }

    .header-subtitle {
      font-size: 15px;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--accent-gold);
      margin-bottom: 2px;
    }

    .header-tagline {
      font-size: 11px;
      font-style: italic;
      color: var(--text-soft);
    }

    /* TOP STRIP ----------------------------------------------------- */

    .top-strip {
      display: flex;
      justify-content: flex-end;
      align-items: stretch;
      padding: 10px 70px 10px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      border-bottom: 1px solid rgba(0, 0, 0, 0.09);
      background: linear-gradient(to bottom, #eafdff, #ffffff);
      font-size: 12px;
    }

    .top-strip-box {
      text-align: right;
    }

    .top-strip-label {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #222;
    }

    .top-strip-amount {
      display: inline-block;
      margin-top: 4px;
      padding: 8px 20px;
      background: var(--blue-dark);
      color: #ffffff;
      border-radius: 4px;
      font-size: 20px;
      font-variant-numeric: tabular-nums;
    }

    /* PYRAMID AREA -------------------------------------------------- */

    .pyramid-section {
      position: relative;
      padding: 26px 70px 140px; /* reduced bottom padding for less white space */
      overflow: hidden;
      align-items: center;
    }

    .big-triangle {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 30px;
      width: 100%;
      height: 620px;
      background: linear-gradient(
        to bottom,
        #eafdff 0%,
        #eafdff 35%,
        #007dba 80%,
        #006da3 100%
      );
      clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }

    .triangle-total {
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 1;
      color: #000;
    }

    .triangle-total-label {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .triangle-total-amount {
      margin-top: 3px;
      font-size: 28px;
      font-weight: bold;
    }

    .triangle-bottom-banner {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
      background: var(--blue-dark);
      color: #ffffff;
      padding: 9px 26px;
      font-size: 25px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-variant-numeric: tabular-nums;
    }

    .row-labels {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 13px;
      margin-top: 135px;
      margin-bottom: 8px;
      padding: 0;
    }

    .row-labels-left {
      font-style: italic;
      color: var(--blue-dark);
    }

    .row-labels-right {
      margin-right: 30px;
      font-style: italic;
      color: var(--blue-dark);
    }

    /* LEVEL ROWS ---------------------------------------------------- */

    .rows {
      position: relative;
      z-index: 1;
    }

    .level-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 24px;
      align-items: center;
      gap: 0;
      margin-bottom: 8px;
    }

    .fraction-pill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0px;
      padding: 2px 6px 1px;
      background: transparent;
      border-radius: 0;
      color: #ffffff;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
      pointer-events: auto;
    }

    .fraction-pill.has-received {
      background: transparent;
      color: #ffffff;
    }

    .fraction-pill input {
      width: 22px;
      border: none;
      background: transparent;
      color: inherit;
      text-align: left;
      font-size: 13px;
      padding: 0;
      margin: 0;
      font-variant-numeric: tabular-nums;
    }

    .fraction-pill span.slash {
      font-size: 11px;
    }

    .fraction-pill input:focus {
      outline: none;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    .bar-wrapper {
      position: relative;
      height: 32px;
      background: none;
      overflow: hidden;
      display: flex;
      align-items: center;
      border-radius: 0;
    }

    .bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(
        to right,
        rgba(187, 114, 58, 0.9) 0%,
        rgba(187, 114, 58, 0.6) 35%,
        rgba(187, 114, 58, 0) 100%
      );
      transition: width 0.18s ease;
      z-index: 0;
    }

    .bar-label {
      position: relative;
      z-index: 1;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 13px;
      color: var(--blue-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    .bar-label input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 13px;
      text-align: center;
      color: inherit;
      padding: 0;
      margin: 0;
    }

    .bar-label input:focus {
      outline: none;
    }

    .right-amount {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 18px;
      min-width: 90px;
      background: transparent;
      color: #ffffff;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
      z-index: 2;
    }

    .level-right {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-btn {
      border: none;
      background: transparent;
      color: #b91c1c;
      font-size: 14px;
      cursor: pointer;
      padding: 0 0 0 4px;
      line-height: 1;
    }

    .delete-btn:hover {
      color: #7f1010;
    }

    .add-row-btn {
      margin-top: 8px;
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid #b7d7ea;
      background: #f0f8ff;
      cursor: pointer;
    }

    .add-row-btn:hover {
      background: #e0f0ff;
    }

    /* SUMMARY ------------------------------------------------------ */

    .summary {
      padding: 10px 70px 18px;
      border-top: 1px solid rgba(0, 0, 0, 0.04);
      background: #f3f9ff;
      font-size: 12px;
    }

    .summary-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      justify-content: space-between;
    }

    .summary-left {
      min-width: 260px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .summary-row span.label {
      color: var(--text-soft);
    }

    .summary-row span.value {
      font-variant-numeric: tabular-nums;
    }

    .summary-progress-outer {
      margin-top: 6px;
      height: 8px;
      border-radius: 999px;
      background: #c4e2f5;
      overflow: hidden;
    }

    .summary-progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--blue-dark), var(--teal));
      transition: width 0.18s ease;
    }

    .summary-right {
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }

    .summary-field {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    .summary-field input {
      margin-top: 3px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #b7d7ea;
      background: #f0f8ff;
      font-size: 12px;
      width: 190px;
      font-family: "Georgia", "Times New Roman", serif;
    }

    /* INDIVIDUAL GIFTS DROPDOWN ------------------------------------ */

    .indiv-section {
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      background: #f2fbff;
      padding: 0 70px 20px;
    }

    .indiv-toggle {
      width: 100%;
      border: none;
      background: #e4f5ff;
      padding: 10px 14px;
      margin: 0 -70px; /* stretch full width of card */
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--blue-dark);
    }

    .indiv-toggle-label {
      padding-left: 70px;
    }

    .indiv-toggle-arrow {
      padding-right: 70px;
      transition: transform 0.2s ease;
    }

    .indiv-toggle.open .indiv-toggle-arrow {
      transform: rotate(180deg);
    }

    .indiv-panel {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.25s ease;
      padding-top: 0;
    }

    .indiv-panel-inner {
      padding-top: 10px;
    }

    .indiv-description {
      font-size: 10px;
      color: #3a6172;
      font-style: italic;
      margin-bottom: 6px;
    }

    .indiv-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .indiv-table th,
    .indiv-table td {
      padding: 6px 6px;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
    }

    .indiv-table th {
      text-align: left;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #3a6172;
    }

    .indiv-table td {
      font-size: 11px;
    }

    .indiv-table tr:nth-child(even) td {
      background: #f4fbff;
    }

    .add-gift-btn {
      margin-top: 10px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #b7d7ea;
      background: #f0f8ff;
      cursor: pointer;
    }

    .add-gift-btn:hover {
      background: #e0f0ff;
    }

    @media (max-width: 960px) {
      body {
        padding: 0;
      }
      .page {
        border-radius: 0;
      }
      .top-strip {
        padding: 10px 24px;
      }
      .pyramid-section {
        padding: 24px 24px 180px;
      }
      .summary {
        padding: 10px 24px 18px;
      }
      .indiv-section {
        padding: 0 24px 20px;
      }
      .indiv-toggle {
        margin: 0 -24px;
      }
      .indiv-toggle-label {
        padding-left: 24px;
      }
      .indiv-toggle-arrow {
        padding-right: 24px;
      }
      .level-row {
        grid-template-columns: minmax(0, 1fr) 24px;
      }
      .row-labels-right {
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="header">
    <div class="header-line-1">TURNING POINT WITH DR. DAVID JEREMIAH</div>
    <div class="header-title" id="headerTitle">LEADERSHIP 200</div>
    <div class="header-subtitle">ACCELERATE YOUR VISION</div>
    <div class="header-tagline">
      Delivering the Unchanging Word of God to an Ever-Changing World
    </div>
  </div>

  <div class="top-strip">
    <div class="top-strip-box">
      <div class="top-strip-label">TOTAL RECEIVED TO DATE</div>
      <div class="top-strip-amount" id="grandReceived">$0</div>
    </div>
  </div>

  <div class="pyramid-section">
    <div class="big-triangle"></div>

    <div class="triangle-total">
      <div class="triangle-total-label">TOTAL</div>
      <div class="triangle-total-amount" id="triangleTotalAmount">$0</div>
    </div>

    <div class="triangle-bottom-banner" id="bottomBanner">
      0 LEADERSHIP GIFTS/PLEDGES
    </div>

    <div class="row-labels">
      <div class="row-labels-left">Gifts Received/Needed</div>
      <div class="row-labels-right">Total Gift/Pledge Dollars Committed</div>
    </div>

    <div class="rows" id="rowsContainer">
      <!-- rows injected by JS -->
    </div>
    <button class="add-row-btn" id="addRowBtn">+ Add Level</button>
  </div>

  <div class="summary">
    <div class="summary-grid">
      <div class="summary-left">
        <div class="summary-row">
          <span class="label">Planned from all levels</span>
          <span class="value" id="plannedTotal">$0</span>
        </div>
        <div class="summary-row">
          <span class="label">Direct Mail Gifts Totaling</span>
          <span class="value" id="directMailDisplay">$3,000,000</span>
        </div>
        <div class="summary-row">
          <span class="label">Campaign goal</span>
          <span class="value" id="goalDisplaySmall">$0</span>
        </div>
        <div class="summary-row">
          <span class="label">Variance</span>
          <span class="value" id="varianceDisplay">$0</span>
        </div>
        <div class="summary-progress-outer">
          <div class="summary-progress-inner" id="summaryProgress"></div>
        </div>
      </div>

      <div class="summary-right">
        <div class="summary-field">
          Campaign Goal ($)
          <input type="number" id="goalInput" placeholder="100000000" />
        </div>
        <div class="summary-field">
          Title
          <input type="text" id="titleInput" placeholder="Leadership 200" />
        </div>
      </div>
    </div>
  </div>

  <!-- INDIVIDUAL GIFTS DROPDOWN -->
  <div class="indiv-section">
    <button class="indiv-toggle" id="indivToggle" type="button">
      <span class="indiv-toggle-label">INDIVIDUAL GIFTS</span>
      <span class="indiv-toggle-arrow">▾</span>
    </button>

    <div class="indiv-panel" id="indivPanel">
      <div class="indiv-panel-inner">
        <p class="indiv-description">
          Each time you increase “Gifts Received” in a level, you’ll be asked to enter
          details for that specific gift. Gifts below are sorted by amount, highest to lowest.
        </p>
        <table class="indiv-table">
          <thead>
          <tr>
            <th style="width: 40px;">#</th>
            <th>Donor Name</th>
            <th style="width: 120px;">ID Number</th>
            <th style="width: 140px;">Gift Amount</th>
            <th>Gift Purpose</th>
          </tr>
          </thead>
          <tbody id="giftsTableBody">
          <!-- rows filled by JS -->
          </tbody>
        </table>
        <button type="button" class="add-gift-btn" id="addGiftBtn">+ Add Gift</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Constant direct mail amount
  const DIRECT_MAIL_TOTAL = 3000000;

  // ---------- BASIC UTILITIES ----------
  function parseNumber(raw) {
    if (raw === null || raw === undefined) return 0;
    if (typeof raw !== "string") raw = String(raw);
    const cleaned = raw.replace(/[^\d.\-]/g, "");
    const n = parseFloat(cleaned);
    return isNaN(n) ? 0 : n;
  }

  function formatCurrency(n) {
    n = Number(n) || 0;
    return "$" + n.toLocaleString("en-US", {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    });
  }

  function extractGiftAmountFromLabel(label) {
    if (!label) return 0;
    const match = label.match(/\$([\d,]+(\.\d+)?)/);
    if (!match) return 0;
    return parseNumber(match[1]);
  }

  // ---------- GIFTS HELPERS ----------

  function getGiftsFromDOM() {
    const rows = Array.from(document.querySelectorAll("#giftsTableBody tr"));
    return rows
      .map((row) => {
        const cells = row.querySelectorAll("td");
        const purposeCell = cells[4];
        let purposeText = "";
        if (purposeCell) {
          const span = purposeCell.querySelector(".gift-purpose");
          purposeText = span ? span.textContent.trim() : purposeCell.textContent.trim();
        }
        return {
          donorName: (cells[1] && cells[1].textContent.trim()) || "",
          idNumber: (cells[2] && cells[2].textContent.trim()) || "",
          amount: parseNumber(cells[3] && cells[3].textContent),
          purpose: purposeText || "",
        };
      })
      .filter((g) => g.amount > 0);
  }

  function renderGiftsTable(gifts) {
    const tbody = document.getElementById("giftsTableBody");
    if (!tbody) return;

    tbody.innerHTML = "";
    gifts.forEach((g, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${g.donorName || ""}</td>
        <td>${g.idNumber || ""}</td>
        <td>${formatCurrency(g.amount || 0)}</td>
        <td>
          <span class="gift-purpose">${g.purpose || ""}</span>
          <button type="button"
                  class="gift-delete-btn"
                  data-index="${idx}"
                  title="Remove gift"
                  style="border:none;background:transparent;color:#b91c1c;font-size:12px;cursor:pointer;margin-left:6px;">
            &times;
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Attach delete handlers
    tbody.querySelectorAll(".gift-delete-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.getAttribute("data-index"), 10);
        let giftsNow = getGiftsFromDOM();
        if (idx >= 0 && idx < giftsNow.length) {
          giftsNow.splice(idx, 1);
          renderGiftsTable(giftsNow);
          recalcAll();
        }
      });
    });

    // keep panel height correct if open
    const indivPanel = document.getElementById("indivPanel");
    const indivToggle = document.getElementById("indivToggle");
    if (indivPanel && indivToggle && indivToggle.classList.contains("open")) {
      indivPanel.style.maxHeight = indivPanel.scrollHeight + "px";
    }
  }

  function addGiftRow(gift) {
    let gifts = getGiftsFromDOM();
    if (gift && gift.amount) {
      gifts.push({
        donorName: gift.donorName || "",
        idNumber: gift.idNumber || "",
        amount: Number(gift.amount) || 0,
        purpose: gift.purpose || "",
      });
    }
    gifts.sort((a, b) => b.amount - a.amount);
    renderGiftsTable(gifts);
  }

  function getGiftsTotal() {
    return getGiftsFromDOM().reduce((sum, g) => sum + g.amount, 0);
  }

  // ---------- MAIN UI & STATE ----------

  const rowsContainer = document.getElementById("rowsContainer");
  const addRowBtn = document.getElementById("addRowBtn");
  const goalInput = document.getElementById("goalInput");
  const titleInput = document.getElementById("titleInput");
  const headerTitleEl = document.getElementById("headerTitle");

  const plannedTotalEl = document.getElementById("plannedTotal");
  const goalDisplaySmallEl = document.getElementById("goalDisplaySmall");
  const varianceDisplayEl = document.getElementById("varianceDisplay");
  const summaryProgressEl = document.getElementById("summaryProgress");
  const grandReceivedEl = document.getElementById("grandReceived");
  const triangleTotalAmountEl = document.getElementById("triangleTotalAmount");
  const bottomBannerEl = document.getElementById("bottomBanner");

  let rowCounter = 0;

  function addRow(defaults = {}) {
    rowCounter++;
    const row = document.createElement("div");
    row.className = "level-row";
    row.dataset.rowId = String(rowCounter);

    const received = defaults.received ?? "";
    const needed = defaults.needed ?? "";
    const label = defaults.label ?? "";

    row.innerHTML = `
      <div class="level-middle">
        <div class="bar-wrapper">
          <div class="bar-fill"></div>

          <div class="fraction-pill">
            <input type="number" min="0" class="received-input" value="${received}">
            <span class="slash">/</span>
            <input type="number" min="0" class="needed-input" value="${needed}">
          </div>

          <div class="bar-label">
            <input type="text" class="label-input" value="${label}"
                   placeholder="1 Gift of $25,000,000">
          </div>

          <div class="right-amount level-received">$0</div>
        </div>
      </div>

      <div class="level-right">
        <button class="delete-btn" type="button" title="Remove row">&times;</button>
      </div>
    `;

    const receivedInput = row.querySelector(".received-input");
    const neededInput = row.querySelector(".needed-input");
    const labelInput = row.querySelector(".label-input");
    const deleteBtn = row.querySelector(".delete-btn");

    // store manual received value separately
    receivedInput.dataset.manualReceived = received || 0;

    receivedInput.addEventListener("input", () => {
      receivedInput.dataset.manualReceived = receivedInput.value;
      recalcAll();
    });

    [neededInput, labelInput].forEach((inp) => {
      inp.addEventListener("input", recalcAll);
    });

    deleteBtn.addEventListener("click", () => {
      row.remove();
      recalcAll();
    });

    rowsContainer.appendChild(row);
  }

  function getStateFromDOM() {
    const rows = Array.from(rowsContainer.querySelectorAll(".level-row")).map((row) => {
      const receivedInput = row.querySelector(".received-input");
      const neededInput = row.querySelector(".needed-input");
      const labelInput = row.querySelector(".label-input");
      return {
        received: parseNumber(receivedInput.dataset.manualReceived ?? receivedInput.value),
        needed: parseNumber(neededInput.value),
        label: labelInput.value || ""
      };
    });

    const gifts = getGiftsFromDOM();

    return {
      goal: parseNumber(goalInput.value),
      title: headerTitleEl.textContent || "LEADERSHIP 200",
      rows: rows,
      gifts: gifts
    };
  }

  function loadStateIntoDOM(state) {
    rowsContainer.innerHTML = "";
    rowCounter = 0;

    goalInput.value = state.goal || "";
    headerTitleEl.textContent = state.title || "LEADERSHIP 200";
    titleInput.value = state.title || "";

    (state.rows || []).forEach(r => {
      addRow({
        received: r.received,
        needed: r.needed,
        label: r.label
      });
    });

    renderGiftsTable(state.gifts || []);
    recalcAll();
  }

  function saveState() {
    const state = getStateFromDOM();
    fetch("/api/state", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(state)
    }).catch(err => {
      console.error("Failed to save state", err);
    });
  }

  function recalcAll() {
    const rows = Array.from(rowsContainer.querySelectorAll(".level-row"));
    const gifts = getGiftsFromDOM();

    // build row info
    const rowInfos = rows.map((row) => {
      const labelInput = row.querySelector(".label-input");
      const baseAmount = extractGiftAmountFromLabel(labelInput.value);
      return { row, baseAmount, gifts: [] };
    });

    // assign gifts to ranges
    for (const gift of gifts) {
      for (let i = 0; i < rowInfos.length; i++) {
        const base = rowInfos[i].baseAmount || 0;
        const upper = i === 0 ? Infinity : (rowInfos[i - 1].baseAmount || Infinity);
        if (gift.amount >= base && gift.amount < upper) {
          rowInfos[i].gifts.push(gift);
          break;
        }
      }
    }

    let plannedTotalLevels = 0;
    let totalNeeded = 0;

    rowInfos.forEach((info) => {
      const row = info.row;
      const receivedInput = row.querySelector(".received-input");
      const neededInput = row.querySelector(".needed-input");
      const labelInput = row.querySelector(".label-input");
      const barFill = row.querySelector(".bar-fill");
      const fractionPill = row.querySelector(".fraction-pill");
      const levelReceivedBox = row.querySelector(".level-received");

      const needed = parseNumber(neededInput.value);
      const giftAmount = info.baseAmount || extractGiftAmountFromLabel(labelInput.value);

      const levelGoal = giftAmount * needed;
      plannedTotalLevels += levelGoal;
      totalNeeded += needed;

      const manualReceived = parseNumber(
        receivedInput.dataset.manualReceived ?? receivedInput.value
      );
      const autoReceived = info.gifts.length;
      const totalReceivedCount = manualReceived + autoReceived;

      receivedInput.value = totalReceivedCount;

      let pct = 0;
      if (needed > 0) pct = Math.max(0, Math.min(1, totalReceivedCount / needed));
      barFill.style.width = (pct * 100) + "%";

      if (totalReceivedCount > 0) {
        fractionPill.classList.add("has-received");
      } else {
        fractionPill.classList.remove("has-received");
      }

      const levelAmountReceived = info.gifts.reduce((sum, g) => sum + g.amount, 0);
      levelReceivedBox.textContent = formatCurrency(levelAmountReceived);
    });

    // Planned totals including direct mail
    const plannedWithDirectMail = plannedTotalLevels + DIRECT_MAIL_TOTAL;

    // alternating gradients
    rows.forEach((row, index) => {
      const barWrapper = row.querySelector(".bar-wrapper");
      if (index % 2 === 0) {
        barWrapper.style.background =
          "linear-gradient(to right," +
          " #006da3 0%," +
          " #007dba 18%," +
          " #eafdff 50%," +
          " #007dba 82%," +
          " #006da3 100%)";
      } else {
        barWrapper.style.background =
          "linear-gradient(to right," +
          " #00878c 0%," +
          " #0073a9 18%," +
          " #eafdff 50%," +
          " #0073a9 82%," +
          " #00878c 100%)";
      }
    });

    plannedTotalEl.textContent = formatCurrency(plannedWithDirectMail);
    triangleTotalAmountEl.textContent = formatCurrency(plannedWithDirectMail);

    const goal = parseNumber(goalInput.value);
    const giftsTotal = gifts.reduce((sum, g) => sum + g.amount, 0);

    if (goal > 0) {
      goalDisplaySmallEl.textContent = formatCurrency(goal);
      const variance = plannedWithDirectMail - goal;
      const sign = variance === 0 ? "" : variance > 0 ? "+ " : "- ";
      varianceDisplayEl.textContent =
        variance === 0 ? "On goal" : sign + formatCurrency(Math.abs(variance));

      const pctGoal = Math.max(0, Math.min(1, giftsTotal / goal));
      summaryProgressEl.style.width = (pctGoal * 100) + "%";
    } else {
      goalDisplaySmallEl.textContent = "$0";
      varianceDisplayEl.textContent = "—";
      summaryProgressEl.style.width = "0%";
    }

    grandReceivedEl.textContent = formatCurrency(giftsTotal);

    const giftsText =
      totalNeeded > 0
        ? totalNeeded.toLocaleString("en-US") + " LEADERSHIP GIFTS/PLEDGES"
        : "0 LEADERSHIP GIFTS/PLEDGES";
    bottomBannerEl.textContent = giftsText;

    saveState();
  }

  // ---------- EVENT WIRING ----------

  goalInput.addEventListener("input", recalcAll);
  titleInput.addEventListener("input", () => {
    headerTitleEl.textContent = titleInput.value || "LEADERSHIP 200";
    saveState();
  });

  if (addRowBtn) {
    addRowBtn.addEventListener("click", () => {
      addRow();
      recalcAll();
    });
  }

  // Individual Gifts dropdown toggle
  const indivToggle = document.getElementById("indivToggle");
  const indivPanel = document.getElementById("indivPanel");
  if (indivToggle && indivPanel) {
    indivPanel.style.maxHeight = "0px";
    indivToggle.addEventListener("click", () => {
      const isOpen = indivToggle.classList.contains("open");
      if (isOpen) {
        indivToggle.classList.remove("open");
        indivPanel.style.maxHeight = "0px";
      } else {
        indivToggle.classList.add("open");
        indivPanel.style.maxHeight = indivPanel.scrollHeight + "px";
      }
    });
  }

  // Add Gift button
  const addGiftBtn = document.getElementById("addGiftBtn");
  if (addGiftBtn) {
    addGiftBtn.addEventListener("click", () => {
      const donorName = prompt("Donor Name:") || "";
      const idNumber = prompt("ID Number (optional):") || "";
      const amountRaw = prompt("Gift Amount (numbers only):") || "0";
      const amount = parseNumber(amountRaw);
      const purpose = prompt("Gift Purpose (optional):") || "";

      addGiftRow({ donorName, idNumber, amount, purpose });
      recalcAll();
    });
  }

  // ---------- INITIAL LOAD ----------

  const defaultState = {
    goal: 100000000,
    title: "LEADERSHIP 200",
    rows: [
      { received: 0, needed: 1, label: "1 Gift of $25,000,000" },
      { received: 0, needed: 1, label: "1 Gift/Pledge of $20,000,000" },
      { received: 1, needed: 1, label: "1 Gift/Pledge of $10,000,000" },
      { received: 0, needed: 1, label: "1 Gift/Pledge of $5,000,000" },
      { received: 0, needed: 2, label: "2 Gifts/Pledges of $2,500,000" },
      { received: 0, needed: 10, label: "10 Gifts/Pledges of $1,000,000" },
      { received: 0, needed: 14, label: "14 Gifts/Pledges of $500,000" },
      { received: 0, needed: 20, label: "20 Gifts/Pledges of $250,000" },
      { received: 0, needed: 50, label: "50 Gifts/Pledges of $100,000" },
      { received: 0, needed: 100, label: "100 Gifts/Pledges of $50,000" }
    ],
    gifts: []
  };

  fetch("/api/state")
    .then(res => res.json())
    .then(state => {
      loadStateIntoDOM(state || defaultState);
    })
    .catch(err => {
      console.error("Failed to load state, falling back to defaults", err);
      loadStateIntoDOM(defaultState);
    });

  // Initialize constant display for direct mail
  const directMailDisplayEl = document.getElementById("directMailDisplay");
  if (directMailDisplayEl) {
    directMailDisplayEl.textContent = formatCurrency(DIRECT_MAIL_TOTAL);
  }
</script>

<!-- GENERATE PDF BUTTON -->
<div style="text-align:center; padding:40px 0;">
  <button id="generatePdfBtn"
          style="
            padding:12px 28px;
            font-size:14px;
            letter-spacing:0.15em;
            text-transform:uppercase;
            background:#006da3;
            color:white;
            border:none;
            border-radius:6px;
            cursor:pointer;">
    Generate PDF
  </button>
</div>

<script>
  document.getElementById("generatePdfBtn").addEventListener("click", () => {
    window.open("/generate-pdf", "_blank");
  });
</script>

</body>
</html>
